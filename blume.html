<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>Blume</title>

	<script src="js/jquery.js"></script>
	<script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
    <script src="http://cdn.leafletjs.com/leaflet-0.7.2/leaflet.js"></script>

	<link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.7.2/leaflet.css" />

    <style>
		#map {
			width: 900px;
			height: 600px;
		}

		.journey {
			fill: none;
			stroke: #000000;
			stroke-width: 3;

		}
    </style>



</head>
<body>

 <div id="map"></div>
<script>

	$(document).ready(function(){

		// $.get( "loadData.php?mode=oneRow&id=45", function( data ) {
		$.get( "loadData.php?mode=allRows&id=45", function( data ) {
		//use underscore.js for transformation?

		// var jsonData = JSON.parse(data);

		// var collection = createGeoJson(jsonData);

			console.log("here", data );

			// drawMap(collection);

		});

	});

	//this function takes coordinates as a string "5.123234345,4.234245345;5.10809823748,4.2734980"
	// and makes a geojson from it
	function createGeoJson(data) {

		var features = [];
		
		//for every feature
		for (var i = 0; i < data.length; i++) {
			

			//correctly format the location data
			// data[i].route = data[i].replace(/\n/g,'');
			// data[i] = data[i].replace(/ /g,'');

			// // console.log( "Load was performed.",  data );
			var arr = data[i].route.split(";");
			var coordinates = new Array();

			//go through all the coordinate pairs, split them by ',' and put them back into main array
			for (var k = 0; k < arr.length; k++) {
				var x = arr[k].split(",");

			// 	//set individual values to int
				for (var j = 0; j < x.length; j++) {
					x[j] = parseFloat(x[j]);
				};

				coordinates.push(x);
			};
			// console.log(coordinates);

			//build the array for the feature
			features.push({
	        	id: data[i].id,
	        	type: "Feature",
	        	geometry: {
	        		type: "LineString",
	        		coordinates: coordinates
	        	},
	        	properties: {
	        		gender: data[i].gender,
	        		journeyType: data[i].journeyType,
	        		weekday: data[i].weekday,
	        		comment: data[i].comment

	        	}
			})	;


		};


		var geojson =   {"type": "FeatureCollection",
			       		"features": features
       				}

		// console.log(geojson);

		return geojson;
	}


	/*
	*	Draws the map using Leaflet and d3js
	*
	*/
	function drawMap(featureCollection) {

		var collection = featureCollection;
		console.log(featureCollection);

        //second way to do it
        var map = new L.Map("map", {center: [55.960, -3.210], zoom: 14})
    	.addLayer(new L.TileLayer("http://{s}.tiles.mapbox.com/v3/kimrdot.k7jn77op/{z}/{x}/{y}.png"));

        var svg = d3.select(map.getPanes().overlayPane).append("svg"),
    		g = svg.append("g").attr("class", "leaflet-zoom-hide");

		//if we want to load data from json:
    	// d3.json("datafile/person-01.json", function(collection) {

		  	var transform = d3.geo.transform({point: projectPoint}),
	    	path = d3.geo.path().projection(transform);

	    	var feature = g.selectAll("path")
			    .data(collection.features)
			  .enter().append("path");


			map.on("viewreset", reset);
			reset();

			//necessary to redraw the svg when user zooms out
			function reset() {
			  	var bounds = path.bounds(collection),
			    topLeft = bounds[0],
			    bottomRight = bounds[1];

			    svg .attr("width", bottomRight[0] - topLeft[0])
			    .attr("height", bottomRight[1] - topLeft[1])
			    .style("left", topLeft[0] + "px")
			    .style("top", topLeft[1] + "px");
				g   .attr("transform", "translate(" + -topLeft[0] + "," + -topLeft[1] + ")");
			  	
			  	feature.attr("d", path)
			  	.attr("class", function(d) { return "journey" });
			}

		// });


		//necessary to map from d3 to leavelet
		function projectPoint(x, y) {
		  var point = map.latLngToLayerPoint(new L.LatLng(y, x));
		  this.stream.point(point.x, point.y);
		}

		
	}

	 

		


</script>

</body>
</html>